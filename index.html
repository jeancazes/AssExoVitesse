<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitesse, Distance & Dur√©e - Application √©ducative</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Nunito', 'Segoe UI', sans-serif; }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-20px); }
      60% { transform: translateY(-10px); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translate(-50%, 100px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    button:hover:not(:disabled) { transform: scale(1.05); }
    button:disabled { opacity: 0.4 !important; cursor: not-allowed !important; }
    textarea:focus { outline: none; border-color: #667eea !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    const { useState, useRef, useEffect } = React;

    // Composant Calculatrice flottante
    function Calculatrice({ onClose }) {
      const [display, setDisplay] = useState('0');
      const [prevValue, setPrevValue] = useState(null);
      const [operation, setOperation] = useState(null);
      const [waitingForOperand, setWaitingForOperand] = useState(false);
      const [position, setPosition] = useState({ x: 20, y: 100 });
      const [isDragging, setIsDragging] = useState(false);
      const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
      const calcRef = useRef(null);

      const handleMouseDown = (e) => {
        if (e.target.tagName === 'BUTTON') return;
        setIsDragging(true);
        setDragStart({ x: e.clientX - position.x, y: e.clientY - position.y });
      };

      const handleMouseMove = (e) => {
        if (!isDragging) return;
        setPosition({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
      };

      const handleMouseUp = () => setIsDragging(false);

      useEffect(() => {
        if (isDragging) {
          window.addEventListener('mousemove', handleMouseMove);
          window.addEventListener('mouseup', handleMouseUp);
        }
        return () => {
          window.removeEventListener('mousemove', handleMouseMove);
          window.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isDragging, dragStart]);

      const inputDigit = (digit) => {
        if (waitingForOperand) { setDisplay(digit); setWaitingForOperand(false); }
        else { setDisplay(display === '0' ? digit : display + digit); }
      };

      const inputDecimal = () => {
        if (waitingForOperand) { setDisplay('0.'); setWaitingForOperand(false); }
        else if (!display.includes('.')) { setDisplay(display + '.'); }
      };

      const clear = () => { setDisplay('0'); setPrevValue(null); setOperation(null); setWaitingForOperand(false); };

      const performOperation = (nextOp) => {
        const inputValue = parseFloat(display);
        if (prevValue === null) { setPrevValue(inputValue); }
        else if (operation) {
          let result;
          switch (operation) {
            case '+': result = prevValue + inputValue; break;
            case '-': result = prevValue - inputValue; break;
            case '√ó': result = prevValue * inputValue; break;
            case '√∑': result = inputValue !== 0 ? prevValue / inputValue : 'Err'; break;
            default: result = inputValue;
          }
          if (typeof result === 'number') result = Math.round(result * 1000000) / 1000000;
          setDisplay(String(result)); setPrevValue(result);
        }
        setWaitingForOperand(true); setOperation(nextOp);
      };

      const calculate = () => {
        if (!operation || prevValue === null) return;
        const inputValue = parseFloat(display);
        let result;
        switch (operation) {
          case '+': result = prevValue + inputValue; break;
          case '-': result = prevValue - inputValue; break;
          case '√ó': result = prevValue * inputValue; break;
          case '√∑': result = inputValue !== 0 ? prevValue / inputValue : 'Err'; break;
          default: result = inputValue;
        }
        if (typeof result === 'number') result = Math.round(result * 1000000) / 1000000;
        setDisplay(String(result)); setPrevValue(null); setOperation(null); setWaitingForOperand(true);
      };

      const cs = {
        wrap: { position: 'fixed', left: position.x, top: position.y, width: '220px', background: '#1c1c1e', borderRadius: '16px', padding: '12px', boxShadow: '0 10px 40px rgba(0,0,0,0.5)', zIndex: 1000, cursor: isDragging ? 'grabbing' : 'grab', userSelect: 'none' },
        header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px', padding: '0 4px' },
        title: { color: '#8e8e93', fontSize: '11px', fontWeight: '600' },
        closeBtn: { background: '#ff5f57', border: 'none', width: '12px', height: '12px', borderRadius: '50%', cursor: 'pointer' },
        screen: { background: '#000', borderRadius: '8px', padding: '10px', marginBottom: '8px', textAlign: 'right', fontSize: '1.8rem', color: '#fff', fontFamily: 'monospace', minHeight: '50px', display: 'flex', alignItems: 'center', justifyContent: 'flex-end', overflow: 'hidden' },
        grid: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '6px' },
        btn: { padding: '12px', fontSize: '1.1rem', border: 'none', borderRadius: '50%', cursor: 'pointer', fontWeight: '500', width: '44px', height: '44px', display: 'flex', alignItems: 'center', justifyContent: 'center' },
        num: { background: '#333', color: '#fff' },
        op: { background: '#ff9f0a', color: '#fff' },
        fn: { background: '#a5a5a5', color: '#000' },
        zero: { borderRadius: '22px', width: 'auto', gridColumn: 'span 2', justifyContent: 'flex-start', paddingLeft: '18px' },
      };

      return (
        <div ref={calcRef} style={cs.wrap} onMouseDown={handleMouseDown}>
          <div style={cs.header}>
            <span style={cs.title}>CALCULATRICE</span>
            <button style={cs.closeBtn} onClick={onClose}></button>
          </div>
          <div style={cs.screen}>{display}</div>
          <div style={cs.grid}>
            <button style={{...cs.btn, ...cs.fn}} onClick={clear}>C</button>
            <button style={{...cs.btn, ...cs.fn}} onClick={() => setDisplay(String(-parseFloat(display)))}>¬±</button>
            <button style={{...cs.btn, ...cs.fn}} onClick={() => setDisplay(String(parseFloat(display)/100))}>%</button>
            <button style={{...cs.btn, ...cs.op}} onClick={() => performOperation('√∑')}>√∑</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('7')}>7</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('8')}>8</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('9')}>9</button>
            <button style={{...cs.btn, ...cs.op}} onClick={() => performOperation('√ó')}>√ó</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('4')}>4</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('5')}>5</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('6')}>6</button>
            <button style={{...cs.btn, ...cs.op}} onClick={() => performOperation('-')}>‚àí</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('1')}>1</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('2')}>2</button>
            <button style={{...cs.btn, ...cs.num}} onClick={() => inputDigit('3')}>3</button>
            <button style={{...cs.btn, ...cs.op}} onClick={() => performOperation('+')}>+</button>
            <button style={{...cs.btn, ...cs.num, ...cs.zero}} onClick={() => inputDigit('0')}>0</button>
            <button style={{...cs.btn, ...cs.num}} onClick={inputDecimal}>,</button>
            <button style={{...cs.btn, ...cs.op}} onClick={calculate}>=</button>
          </div>
        </div>
      );
    }

    // Probl√®mes par niveau de difficult√© (12 exercices par niveau)
    const problemsByLevel = {
      debutant: [
        // Th√®me: Marche / Randonn√©e
        { type: 'vitesse', enonce: "Luna a march√© pendant 3 heures et a parcouru 12 km. √Ä quelle vitesse s'est-elle d√©plac√©e ?", distance: 12, temps: 3, unite_distance: 'km', unite_temps: 'h', reponse: 4, unite_reponse: 'km/h' },
        { type: 'vitesse', enonce: "Pendant une randonn√©e, Paul a parcouru 15 km en 5 heures. Quelle √©tait sa vitesse moyenne ?", distance: 15, temps: 5, unite_distance: 'km', unite_temps: 'h', reponse: 3, unite_reponse: 'km/h' },
        { type: 'distance', enonce: "Marie marche √† 5 km/h. Quelle distance parcourt-elle en 2 heures ?", vitesse: 5, temps: 2, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 10, unite_reponse: 'km' },
        // Th√®me: V√©lo
        { type: 'vitesse', enonce: "Tom a fait du v√©lo pendant 2 heures et a parcouru 20 km. Quelle √©tait sa vitesse ?", distance: 20, temps: 2, unite_distance: 'km', unite_temps: 'h', reponse: 10, unite_reponse: 'km/h' },
        { type: 'distance', enonce: "Emma roule √† v√©lo √† 12 km/h. Quelle distance parcourt-elle en 3 heures ?", vitesse: 12, temps: 3, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 36, unite_reponse: 'km' },
        { type: 'vitesse', enonce: "L√©o a p√©dal√© 24 km en 4 heures. √Ä quelle vitesse roulait-il ?", distance: 24, temps: 4, unite_distance: 'km', unite_temps: 'h', reponse: 6, unite_reponse: 'km/h' },
        // Th√®me: Animaux lents
        { type: 'distance', enonce: "Une tortue avance √† 2 km/h. Quelle distance parcourt-elle en 4 heures ?", vitesse: 2, temps: 4, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 8, unite_reponse: 'km' },
        { type: 'distance', enonce: "Un escargot se d√©place √† 0.05 m/s. Quelle distance parcourt-il en 20 secondes ?", vitesse: 0.05, temps: 20, unite_vitesse: 'm/s', unite_temps: 's', reponse: 1, unite_reponse: 'm' },
        { type: 'vitesse', enonce: "Une chenille parcourt 6 m√®tres en 2 minutes. Quelle est sa vitesse en m/min ?", distance: 6, temps: 2, unite_distance: 'm', unite_temps: 'min', reponse: 3, unite_reponse: 'm/min' },
        // Th√®me: Voiture / Bus
        { type: 'distance', enonce: "Une voiture roule √† 50 km/h. Quelle distance parcourt-elle en 2 heures ?", vitesse: 50, temps: 2, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 100, unite_reponse: 'km' },
        { type: 'vitesse', enonce: "Un bus scolaire a parcouru 30 km en 1 heure. Quelle √©tait sa vitesse ?", distance: 30, temps: 1, unite_distance: 'km', unite_temps: 'h', reponse: 30, unite_reponse: 'km/h' },
        { type: 'distance', enonce: "Le car de l'√©cole roule √† 40 km/h. Quelle distance parcourt-il en 3 heures ?", vitesse: 40, temps: 3, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 120, unite_reponse: 'km' },
      ],
      apprenti: [
        // Th√®me: Marche / Course
        { type: 'vitesse', enonce: "Gaspard a march√© pendant 2h et a parcouru 16 km. √Ä quelle vitesse est-il all√© ?", distance: 16, temps: 2, unite_distance: 'km', unite_temps: 'h', reponse: 8, unite_reponse: 'km/h' },
        { type: 'temps', enonce: "Sarah court √† 10 km/h. Combien de temps lui faut-il pour parcourir 5 km ?", vitesse: 10, distance: 5, unite_vitesse: 'km/h', unite_distance: 'km', reponse: 0.5, unite_reponse: 'h' },
        { type: 'distance', enonce: "Un jogger court √† 8 km/h pendant 1h30. Quelle distance parcourt-il ?", vitesse: 8, temps: 1.5, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 12, unite_reponse: 'km' },
        // Th√®me: Train
        { type: 'distance', enonce: "Quelle distance aura parcouru le TGV (300 km/h) au bout de 2h de voyage ?", vitesse: 300, temps: 2, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 600, unite_reponse: 'km' },
        { type: 'temps', enonce: "Un train roule √† 150 km/h. Combien de temps met-il pour faire 300 km ?", vitesse: 150, distance: 300, unite_vitesse: 'km/h', unite_distance: 'km', reponse: 2, unite_reponse: 'h' },
        { type: 'vitesse', enonce: "Le TER parcourt 120 km en 2 heures. Quelle est sa vitesse moyenne ?", distance: 120, temps: 2, unite_distance: 'km', unite_temps: 'h', reponse: 60, unite_reponse: 'km/h' },
        // Th√®me: V√©lo / Cyclisme
        { type: 'vitesse', enonce: "Un cycliste parcourt 45 km en 3 heures. Quelle est sa vitesse moyenne ?", distance: 45, temps: 3, unite_distance: 'km', unite_temps: 'h', reponse: 15, unite_reponse: 'km/h' },
        { type: 'distance', enonce: "Un cycliste du Tour de France roule √† 40 km/h pendant 4 heures. Quelle distance parcourt-il ?", vitesse: 40, temps: 4, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 160, unite_reponse: 'km' },
        { type: 'temps', enonce: "Julie roule √† 20 km/h. Combien de temps met-elle pour parcourir 30 km ?", vitesse: 20, distance: 30, unite_vitesse: 'km/h', unite_distance: 'km', reponse: 1.5, unite_reponse: 'h' },
        // Th√®me: Voiture
        { type: 'temps', enonce: "Combien de temps met une voiture roulant √† 60 km/h pour parcourir 180 km ?", vitesse: 60, distance: 180, unite_vitesse: 'km/h', unite_distance: 'km', reponse: 3, unite_reponse: 'h' },
        { type: 'vitesse', enonce: "Une voiture parcourt 200 km en 4 heures. Quelle est sa vitesse moyenne ?", distance: 200, temps: 4, unite_distance: 'km', unite_temps: 'h', reponse: 50, unite_reponse: 'km/h' },
        { type: 'distance', enonce: "Une voiture roule √† 90 km/h sur l'autoroute pendant 3 heures. Quelle distance parcourt-elle ?", vitesse: 90, temps: 3, unite_vitesse: 'km/h', unite_temps: 'h', reponse: 270, unite_reponse: 'km' },
      ],
      maitre: [
        // Th√®me: Conversions m/s ‚Üî km/h
        { type: 'conversion', enonce: "Convertir 15 m/s en km/h.", valeur: 15, de: 'm/s', vers: 'km/h', reponse: 54, unite_reponse: 'km/h' },
        { type: 'conversion', enonce: "Convertir 20 m/s en km/h.", valeur: 20, de: 'm/s', vers: 'km/h', reponse: 72, unite_reponse: 'km/h' },
        { type: 'conversion', enonce: "Convertir 90 km/h en m/s.", valeur: 90, de: 'km/h', vers: 'm/s', reponse: 25, unite_reponse: 'm/s' },
        // Th√®me: Animaux rapides avec conversion
        { type: 'vitesse_conversion', enonce: "Quelle est la vitesse (en km/h) d'un animal qui court 300 m en 10 s ?", distance: 300, temps: 10, unite_distance: 'm', unite_temps: 's', reponse: 108, unite_reponse: 'km/h' },
        { type: 'vitesse_conversion', enonce: "Un l√©vrier court 400 m en 20 secondes. Quelle est sa vitesse en km/h ?", distance: 400, temps: 20, unite_distance: 'm', unite_temps: 's', reponse: 72, unite_reponse: 'km/h' },
        { type: 'vitesse_conversion', enonce: "Un faucon en piqu√© parcourt 500 m en 5 secondes. Quelle est sa vitesse en km/h ?", distance: 500, temps: 5, unite_distance: 'm', unite_temps: 's', reponse: 360, unite_reponse: 'km/h' },
        // Th√®me: Probl√®mes avec minutes
        { type: 'distance_conversion', enonce: "Quelle distance (en m) aura parcouru une voiture (80 km/h) qui roule pendant 45 minutes ?", vitesse: 80, temps: 45, unite_vitesse: 'km/h', unite_temps: 'min', reponse: 60000, unite_reponse: 'm' },
        { type: 'distance_conversion', enonce: "Un cycliste roule √† 30 km/h pendant 20 minutes. Quelle distance (en km) parcourt-il ?", vitesse: 30, temps: 20, unite_vitesse: 'km/h', unite_temps: 'min', reponse: 10, unite_reponse: 'km' },
        { type: 'temps', enonce: "Combien de minutes faut-il √† un coureur allant √† 12 km/h pour parcourir 3 km ?", vitesse: 12, distance: 3, unite_vitesse: 'km/h', unite_distance: 'km', reponse: 15, unite_reponse: 'min' },
        // Th√®me: Horaires
        { type: 'temps', enonce: "√Ä quelle heure arrivera un bus parti √† 7h00 s'il roule √† 80 km/h pour parcourir 40 km ?", vitesse: 80, distance: 40, depart: '7h00', reponse: '7h30', unite_reponse: '' },
        { type: 'temps', enonce: "Un train part √† 9h00 et roule √† 100 km/h. √Ä quelle heure arrivera-t-il apr√®s 150 km ?", vitesse: 100, distance: 150, depart: '9h00', reponse: '10h30', unite_reponse: '' },
        { type: 'temps', enonce: "Marie part √† 14h00 en v√©lo √† 15 km/h. √Ä quelle heure arrivera-t-elle apr√®s 30 km ?", vitesse: 15, distance: 30, depart: '14h00', reponse: '16h00', unite_reponse: '' },
      ],
      expert: [
        // Th√®me: Espace et lumi√®re
        { type: 'annee_lumiere', enonce: "Combien mesure une ann√©e-lumi√®re ? (La lumi√®re voyage √† 300 000 000 m/s)", vitesse: 300000000, temps_description: 'un an', reponse: 9467000000000000, unite_reponse: 'm' },
        { type: 'complexe', enonce: "La Lune est √† 384 400 km de la Terre. En combien de temps (en secondes) la lumi√®re (300 000 km/s) atteint-elle la Terre ?", vitesse: 300000, distance: 384400, reponse: 1.28, unite_reponse: 's' },
        { type: 'complexe', enonce: "Le Soleil est √† 150 millions de km de la Terre. En combien de minutes la lumi√®re (300 000 km/s) nous parvient-elle ?", vitesse: 300000, distance: 150000000, reponse: 8.33, unite_reponse: 'min' },
        { type: 'complexe', enonce: "La sonde Voyager 1 voyage √† 17 km/s. Combien de km parcourt-elle en une journ√©e ?", vitesse: 17, temps: 86400, reponse: 1468800, unite_reponse: 'km' },
        // Th√®me: Tour du monde
        { type: 'complexe', enonce: "Un avion vole √† 900 km/h. Combien de temps lui faut-il pour faire le tour de la Terre (40 000 km) ?", vitesse: 900, distance: 40000, reponse: 44.4, unite_reponse: 'h' },
        { type: 'complexe', enonce: "Un voilier navigue √† 15 km/h. Combien de jours lui faut-il pour traverser l'Atlantique (6000 km) ?", vitesse: 15, distance: 6000, reponse: 16.67, unite_reponse: 'jours' },
        { type: 'complexe', enonce: "L'ISS orbite √† 28 000 km/h. Combien de temps (en minutes) met-elle pour faire un tour de la Terre (42 000 km) ?", vitesse: 28000, distance: 42000, reponse: 90, unite_reponse: 'min' },
        // Th√®me: Comparaisons et conversions complexes
        { type: 'conversion_complexe', enonce: "Un gu√©pard court √† 30 m/s. Est-il plus rapide qu'une voiture roulant √† 100 km/h ? Justifie ta r√©ponse.", vitesse1: 30, vitesse2: 100, comparaison: true },
        { type: 'conversion_complexe', enonce: "Usain Bolt court le 100m en 9.58s. Un TGV roule √† 320 km/h. Qui est le plus rapide ? Justifie.", vitesse1: 10.44, vitesse2: 320, comparaison: true },
        { type: 'complexe', enonce: "Un son voyage √† 340 m/s. Tu vois un √©clair et entends le tonnerre 6 secondes plus tard. √Ä quelle distance (en km) est l'orage ?", vitesse: 340, temps: 6, reponse: 2.04, unite_reponse: 'km' },
        // Th√®me: Probl√®mes √† √©tapes
        { type: 'complexe', enonce: "Un marathonien court 42 km. Il fait les 21 premiers km √† 15 km/h et les 21 suivants √† 12 km/h. Quel est son temps total ?", reponse: 3.15, unite_reponse: 'h' },
        { type: 'complexe', enonce: "Une fus√©e acc√©l√®re de 0 √† 28 000 km/h en 8 minutes pour atteindre l'orbite. Quelle est sa vitesse moyenne durant cette phase ?", reponse: 14000, unite_reponse: 'km/h' },
      ]
    };

    function VitesseApp() {
      const [niveau, setNiveau] = useState(null);
      const [probleme, setProbleme] = useState(null);
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [score, setScore] = useState({ etoiles: 0, problemesResolus: 0, sanAide: 0 });
      const [etape, setEtape] = useState('connexion'); // Commence par connexion
      const [aideUtilisee, setAideUtilisee] = useState(false);
      const messagesEndRef = useRef(null);
      const [historique, setHistorique] = useState([]);
      const [problemeResolu, setProblemeResolu] = useState(false);
      const [etapesValidees, setEtapesValidees] = useState({ si: false, alors: false, donc: false });
      const [showCalc, setShowCalc] = useState(false);
      const [prenomEleve, setPrenomEleve] = useState('');
      const [inputPrenom, setInputPrenom] = useState('');

      // Charger les donn√©es sauvegard√©es au d√©marrage
      useEffect(() => {
        const savedData = localStorage.getItem('vitesse_eleve');
        if (savedData) {
          const data = JSON.parse(savedData);
          setPrenomEleve(data.prenom);
          setScore(data.score || { etoiles: 0, problemesResolus: 0, sanAide: 0 });
          setEtape('accueil');
        }
      }, []);

      // Sauvegarder les scores √† chaque changement
      useEffect(() => {
        if (prenomEleve) {
          const data = { prenom: prenomEleve, score, lastUpdate: new Date().toISOString() };
          localStorage.setItem('vitesse_eleve', JSON.stringify(data));
          // Envoyer au serveur
          fetch('/api/scores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          }).catch(err => console.log('Erreur sync scores:', err));
        }
      }, [score, prenomEleve]);

      const connexion = () => {
        if (inputPrenom.trim().length >= 2) {
          const prenom = inputPrenom.trim();
          setPrenomEleve(prenom);
          setEtape('accueil');
        }
      };

      const deconnexion = () => {
        localStorage.removeItem('vitesse_eleve');
        setPrenomEleve('');
        setScore({ etoiles: 0, problemesResolus: 0, sanAide: 0 });
        setEtape('connexion');
        setInputPrenom('');
      };

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const niveaux = [
        { id: 'debutant', nom: 'üå± D√©butant', description: 'Je d√©couvre les calculs de vitesse', couleur: '#4CAF50' },
        { id: 'apprenti', nom: 'üìö Apprenti', description: 'Je commence √† ma√Ætriser les formules', couleur: '#2196F3' },
        { id: 'maitre', nom: '‚≠ê Ma√Ætre', description: 'Je sais convertir les unit√©s', couleur: '#FF9800' },
        { id: 'expert', nom: 'üöÄ Expert', description: 'Les probl√®mes complexes ne me font pas peur !', couleur: '#9C27B0' },
      ];

      const choisirProbleme = (niveauChoisi) => {
        const problemes = problemsByLevel[niveauChoisi];
        const problemeAleatoire = problemes[Math.floor(Math.random() * problemes.length)];
        setProbleme(problemeAleatoire);
        setNiveau(niveauChoisi);
        setEtape('resolution');
        setAideUtilisee(false);
        setProblemeResolu(false);
        setEtapesValidees({ si: false, alors: false, donc: false });
        setMessages([]);
        
        const messageIntro = niveauChoisi === 'debutant' 
          ? `Super ! Pour r√©soudre ce probl√®me, on va utiliser la m√©thode "Si... Alors... Donc..." !\n\nüëâ Commence par √©crire "Si..." et rappelle les donn√©es importantes du probl√®me.`
          : `N'oublie pas la m√©thode :\n‚Ä¢ Si... (rappeler les donn√©es)\n‚Ä¢ Alors comme... (choisir la formule et calculer)\n‚Ä¢ Donc... (donner la r√©ponse avec l'unit√©)\n\n√Ä toi de jouer ! üí™`;
        
        setMessages([{ role: 'assistant', content: messageIntro }]);
      };

      const envoyerMessage = async () => {
        if (!inputValue.trim() || isLoading) return;

        const nouveauMessage = { role: 'user', content: inputValue };
        setMessages(prev => [...prev, nouveauMessage]);
        setInputValue('');
        setIsLoading(true);

        try {
          const systemPrompt = `Tu es un assistant d'√©ducation chaleureux et bienveillant qui aide des √©l√®ves de 10-12 ans √† r√©soudre des probl√®mes de vitesse, distance et dur√©e.

PR√âNOM DE L'√âL√àVE: ${prenomEleve}
IMPORTANT: Utilise le pr√©nom "${prenomEleve}" pour t'adresser √† l'√©l√®ve de mani√®re personnalis√©e et chaleureuse.

PROBL√àME ACTUEL: ${probleme.enonce}
R√âPONSE ATTENDUE: ${probleme.reponse} ${probleme.unite_reponse}
NIVEAU: ${niveau}
AIDE UTILIS√âE: ${aideUtilisee}

M√âTHODE √Ä SUIVRE (Si... Alors... Donc...):
1. Si... [rappeler les donn√©es utiles de l'√©nonc√©]
2. Alors comme... [choisir la bonne formule : v=D/t, D=v√ót, ou t=D/v] et [faire le calcul]
3. Donc... [donner la r√©ponse avec une phrase compl√®te et l'unit√© de mesure]

FORMULES:
- Vitesse = Distance √∑ Temps (v = D/t)
- Distance = Vitesse √ó Temps (D = v √ó t)
- Temps = Distance √∑ Vitesse (t = D/v)
- Conversion : 1 m/s = 3.6 km/h
- UNIT√âS DE VITESSE AUTORIS√âES : km/h et m/s uniquement

TON R√îLE:
${niveau === 'debutant' ? `
- Guide ${prenomEleve} PAS √Ä PAS √† travers chaque √©tape de la m√©thode
- Si ${prenomEleve} n'a pas commenc√© par "Si...", encourage-le gentiment √† le faire
- F√©licite chaque bonne √©tape, m√™me partielle
- Donne des indices si ${prenomEleve} bloque, mais ne donne JAMAIS la r√©ponse directement
- Utilise des √©mojis pour rendre tes messages plus chaleureux üòä
` : `
- Laisse ${prenomEleve} plus autonome mais reste disponible pour aider
- Corrige les erreurs avec bienveillance
- Encourage ${prenomEleve} √† v√©rifier ses unit√©s de mesure
`}

R√àGLES IMPORTANTES:
- Parle avec chaleur, comme un grand fr√®re/grande s≈ìur bienveillant(e)
- Utilise le pr√©nom "${prenomEleve}" r√©guli√®rement pour personnaliser tes r√©ponses
- Utilise un langage simple adapt√© √† des enfants de 10-12 ans
- Ne donne JAMAIS la r√©ponse compl√®te directement
- Valorise les efforts, m√™me si la r√©ponse n'est pas parfaite

SYST√àME DE VALIDATION PAR √âTAPES :
Tu dois valider chaque √©tape s√©par√©ment et utiliser des marqueurs sp√©cifiques pour que l'√©l√®ve gagne des √©toiles :

1. Quand ${prenomEleve} √©crit correctement le "Si..." avec les bonnes donn√©es (${probleme.type === 'vitesse' ? `distance: ${probleme.distance} ${probleme.unite_distance}, temps: ${probleme.temps} ${probleme.unite_temps}` : probleme.type === 'distance' ? `vitesse: ${probleme.vitesse} ${probleme.unite_vitesse}, temps: ${probleme.temps} ${probleme.unite_temps}` : `les donn√©es du probl√®me`}), r√©ponds avec "‚≠ê √âTAPE SI VALID√âE !" puis encourage-le √† continuer avec "Alors comme..."

2. Quand ${prenomEleve} √©crit correctement le "Alors comme..." avec la bonne formule et le bon calcul, r√©ponds avec "‚≠ê √âTAPE ALORS VALID√âE !" puis encourage-le √† conclure avec "Donc..."

3. Quand ${prenomEleve} √©crit correctement le "Donc..." avec une phrase compl√®te contenant la r√©ponse ${probleme.reponse} ${probleme.unite_reponse}, r√©ponds avec "üéâ BRAVO ${prenomEleve.toUpperCase()} ! EXERCICE R√âUSSI !" et f√©licite-le chaleureusement.

ATTENTION :
- N'utilise ces marqueurs QUE quand l'√©tape est CORRECTE
- Si ${prenomEleve} fait une erreur, aide-le gentiment sans utiliser les marqueurs
- Ne propose JAMAIS de nouveau probl√®me, les boutons s'afficheront automatiquement √† la fin
- L'√©l√®ve peut √©crire plusieurs √©tapes d'un coup, dans ce cas valide toutes les √©tapes correctes`;

          const response = await fetch('/api/chat', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              system: systemPrompt,
              messages: [...messages, nouveauMessage].map(m => ({
                role: m.role,
                content: m.content
              })),
            })
          });

          const data = await response.json();
          const assistantMessage = data.content[0].text;
          
          setMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);
          
          let nouvellesEtoiles = 0;
          
          if (assistantMessage.includes('√âTAPE SI VALID√âE') && !etapesValidees.si) {
            setEtapesValidees(prev => ({ ...prev, si: true }));
            nouvellesEtoiles += 1;
          }
          
          if (assistantMessage.includes('√âTAPE ALORS VALID√âE') && !etapesValidees.alors) {
            setEtapesValidees(prev => ({ ...prev, alors: true }));
            nouvellesEtoiles += 1;
          }
          
          if (assistantMessage.includes('EXERCICE R√âUSSI')) {
            setProblemeResolu(true);
            setEtapesValidees(prev => ({ ...prev, donc: true }));
            nouvellesEtoiles += aideUtilisee ? 1 : 2;
            setScore(prev => ({
              etoiles: prev.etoiles + nouvellesEtoiles,
              problemesResolus: prev.problemesResolus + 1,
              sanAide: aideUtilisee ? prev.sanAide : prev.sanAide + 1
            }));
            setHistorique(prev => [...prev, { niveau, reussi: true, aideUtilisee }]);
          } else if (nouvellesEtoiles > 0) {
            setScore(prev => ({
              ...prev,
              etoiles: prev.etoiles + nouvellesEtoiles
            }));
          }
          
          if (assistantMessage.includes('indice') || assistantMessage.includes('aide')) {
            setAideUtilisee(true);
          }

        } catch (error) {
          console.error('Erreur:', error);
          setMessages(prev => [...prev, { 
            role: 'assistant', 
            content: "Oups ! J'ai eu un petit probl√®me technique. üîß Peux-tu r√©essayer ?" 
          }]);
        }

        setIsLoading(false);
      };

      const nouveauProbleme = (niveauSuivant = null) => {
        const niveauActuel = niveauSuivant || niveau;
        choisirProbleme(niveauActuel);
      };

      const niveauSuivant = () => {
        const niveauxOrdre = ['debutant', 'apprenti', 'maitre', 'expert'];
        const indexActuel = niveauxOrdre.indexOf(niveau);
        if (indexActuel < niveauxOrdre.length - 1) {
          choisirProbleme(niveauxOrdre[indexActuel + 1]);
        }
      };

      // Styles
      const styles = {
        container: {
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          fontFamily: "'Nunito', 'Segoe UI', sans-serif",
          padding: '20px',
        },
        accueil: { maxWidth: '800px', margin: '0 auto', textAlign: 'center' },
        logoContainer: { marginBottom: '30px' },
        logo: { fontSize: '80px', display: 'block', animation: 'bounce 2s infinite' },
        titre: { color: 'white', fontSize: '2.5rem', marginBottom: '10px', textShadow: '2px 2px 4px rgba(0,0,0,0.3)' },
        sousTitre: { color: 'rgba(255,255,255,0.9)', fontSize: '1.2rem' },
        bulle: { background: 'white', borderRadius: '20px', padding: '25px', maxWidth: '500px', margin: '0 auto', boxShadow: '0 10px 30px rgba(0,0,0,0.2)' },
        methode: { color: '#667eea', fontSize: '1.3rem', margin: '15px 0' },
        boutonCommencer: { background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', color: 'white', border: 'none', padding: '18px 40px', fontSize: '1.3rem', borderRadius: '50px', cursor: 'pointer', boxShadow: '0 8px 25px rgba(240,147,251,0.4)', marginBottom: '40px' },
        formules: { background: 'rgba(255,255,255,0.15)', borderRadius: '20px', padding: '25px', backdropFilter: 'blur(10px)' },
        formulesGrid: { display: 'flex', justifyContent: 'center', gap: '20px', flexWrap: 'wrap', marginTop: '15px' },
        formuleCard: { background: 'white', borderRadius: '15px', padding: '20px', minWidth: '150px', boxShadow: '0 5px 15px rgba(0,0,0,0.1)' },
        formuleIcone: { fontSize: '2rem' },
        formuleTexte: { fontFamily: 'monospace', fontSize: '1.2rem', color: '#667eea', fontWeight: 'bold' },
        methodeSection: { background: 'rgba(255,255,255,0.95)', borderRadius: '20px', padding: '25px', marginTop: '25px', textAlign: 'left' },
        methodeExplication: { display: 'flex', flexDirection: 'column', gap: '15px', marginTop: '20px' },
        methodeEtape: { display: 'flex', alignItems: 'center', gap: '15px', background: 'linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%)', padding: '15px 20px', borderRadius: '15px' },
        etapeNumero: { background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', width: '40px', height: '40px', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 'bold', fontSize: '1.2rem', flexShrink: 0 },
        etapeContenu: { flex: 1 },
        etapeTitre: { color: '#667eea', fontSize: '1.1rem' },
        etapeDesc: { color: '#555', margin: '5px 0 0 0', fontSize: '0.95rem' },
        exempleSection: { background: 'rgba(255,255,255,0.95)', borderRadius: '20px', padding: '25px', marginTop: '25px', textAlign: 'left' },
        exempleEnonce: { display: 'flex', alignItems: 'flex-start', gap: '12px', background: '#fff3e0', padding: '18px', borderRadius: '15px', borderLeft: '4px solid #ff9800' },
        exempleIcon: { fontSize: '1.5rem', flexShrink: 0 },
        exempleSolution: { marginTop: '20px', display: 'flex', flexDirection: 'column', gap: '12px' },
        solutionLigne: { display: 'flex', alignItems: 'center', gap: '15px', padding: '12px 18px', background: '#f8f9fa', borderRadius: '12px' },
        solutionLabel: { background: '#667eea', color: 'white', padding: '6px 14px', borderRadius: '20px', fontWeight: 'bold', fontSize: '0.9rem', flexShrink: 0 },
        donnee: { background: '#e3f2fd', padding: '2px 8px', borderRadius: '5px', color: '#1976d2', fontWeight: 'bold', textDecoration: 'underline' },
        formuleHighlight: { background: '#f3e5f5', padding: '2px 8px', borderRadius: '5px', color: '#7b1fa2', fontFamily: 'monospace', fontWeight: 'bold' },
        reponseFinale: { background: '#e8f5e9', padding: '5px 12px', borderRadius: '8px', color: '#2e7d32', fontWeight: 'bold' },
        astuces: { marginTop: '20px', background: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', padding: '18px', borderRadius: '15px', fontSize: '0.95rem' },
        choixNiveau: { maxWidth: '900px', margin: '0 auto', textAlign: 'center' },
        titreNiveau: { color: 'white', fontSize: '2rem', marginBottom: '20px' },
        scoreDisplay: { display: 'flex', justifyContent: 'center', gap: '30px', marginBottom: '30px', color: 'white', fontSize: '1.1rem' },
        niveauxGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '30px' },
        niveauCard: { background: 'white', border: '3px solid', borderRadius: '20px', padding: '25px', cursor: 'pointer', display: 'flex', flexDirection: 'column', gap: '10px' },
        niveauNom: { fontSize: '1.4rem', fontWeight: 'bold' },
        niveauDesc: { fontSize: '0.9rem', color: '#666' },
        boutonRetour: { background: 'transparent', color: 'white', border: '2px solid white', padding: '12px 25px', borderRadius: '25px', cursor: 'pointer', fontSize: '1rem' },
        header: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px', maxWidth: '900px', margin: '0 auto 15px' },
        boutonRetourPetit: { background: 'rgba(255,255,255,0.2)', color: 'white', border: 'none', padding: '10px 20px', borderRadius: '20px', cursor: 'pointer', fontSize: '0.9rem' },
        scoreHeader: { display: 'flex', alignItems: 'center', gap: '15px' },
        etoiles: { background: 'rgba(255,255,255,0.2)', padding: '8px 15px', borderRadius: '15px', color: 'white', fontWeight: 'bold' },
        badge: { background: 'white', padding: '8px 15px', borderRadius: '15px', fontWeight: 'bold', color: '#667eea' },
        chatWrapper: { maxWidth: '900px', margin: '0 auto' },
        stickyHeader: { position: 'sticky', top: 0, zIndex: 100, borderRadius: '25px 25px 0 0', overflow: 'hidden', boxShadow: '0 4px 15px rgba(0,0,0,0.1)' },
        chatContainer: { background: 'white', borderRadius: '0 0 25px 25px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)' },
        enonceFixe: { background: 'linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%)', padding: '20px 25px', borderBottom: '3px solid rgba(0,0,0,0.1)' },
        enonceLabel: { color: 'rgba(255,255,255,0.9)', fontSize: '0.85rem', fontWeight: 'bold', textTransform: 'uppercase', letterSpacing: '1px' },
        enonceTexte: { color: 'white', fontSize: '1.15rem', fontWeight: '600', margin: '10px 0 0 0', lineHeight: '1.5', textShadow: '1px 1px 2px rgba(0,0,0,0.2)' },
        progressionEtapes: { display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '15px', padding: '15px 20px', background: 'linear-gradient(135deg, #f5f7fa 0%, #e8eaed 100%)', borderBottom: '1px solid #e0e0e0', flexWrap: 'wrap' },
        progressionLabel: { fontWeight: 'bold', color: '#555', fontSize: '0.9rem' },
        etapeProgress: { padding: '8px 15px', borderRadius: '20px', background: '#fff', border: '2px solid #e0e0e0', fontSize: '0.9rem', color: '#888', transition: 'all 0.3s ease' },
        etapeValidee: { background: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', borderColor: '#4CAF50', color: '#2e7d32', fontWeight: 'bold' },
        messagesContainer: { padding: '20px', display: 'flex', flexDirection: 'column', gap: '15px' },
        message: { display: 'flex', alignItems: 'flex-start', gap: '10px' },
        messageUser: { flexDirection: 'row-reverse' },
        messageAssistant: { flexDirection: 'row' },
        avatar: { fontSize: '2rem', flexShrink: 0 },
        messageBulle: { padding: '15px 20px', borderRadius: '20px', maxWidth: '70%' },
        bulleUser: { background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', borderBottomRightRadius: '5px' },
        bulleAssistant: { background: '#f0f2f5', color: '#333', borderBottomLeftRadius: '5px' },
        messageLine: { margin: '5px 0', lineHeight: '1.5' },
        loading: { display: 'flex', gap: '5px', padding: '20px', justifyContent: 'center' },
        loadingDot: { color: '#667eea', animation: 'pulse 1.5s infinite' },
        boutonsCopie: { display: 'flex', alignItems: 'center', gap: '10px', padding: '10px 20px', background: 'linear-gradient(135deg, #e8f4fd 0%, #d4e9f7 100%)', borderTop: '1px solid #e0e0e0', flexWrap: 'wrap' },
        copieLabel: { fontSize: '0.85rem', color: '#555', fontWeight: '600' },
        boutonCopie: { background: 'white', border: '2px solid #2196F3', color: '#2196F3', padding: '8px 15px', borderRadius: '20px', cursor: 'pointer', fontSize: '0.85rem', fontWeight: '600' },
        inputContainer: { display: 'flex', gap: '10px', padding: '15px 20px', borderTop: '1px solid #eee', background: '#fafafa' },
        input: { flex: 1, padding: '15px', borderRadius: '15px', border: '2px solid #e0e0e0', fontSize: '1rem', resize: 'none', fontFamily: 'inherit' },
        boutonEnvoyer: { background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', border: 'none', padding: '15px 25px', borderRadius: '15px', cursor: 'pointer', fontSize: '1rem', fontWeight: 'bold' },
        aideRapide: { display: 'flex', alignItems: 'center', gap: '10px', padding: '10px 20px', background: '#f5f5f5', flexWrap: 'wrap', borderRadius: '0 0 25px 25px' },
        aideLabel: { fontSize: '0.9rem', color: '#666' },
        aideBtn: { background: '#e8e8e8', border: 'none', padding: '8px 15px', borderRadius: '10px', cursor: 'pointer', fontSize: '0.85rem' },
        formuleRappel: { marginLeft: 'auto', fontSize: '0.85rem', color: '#667eea', fontFamily: 'monospace', fontWeight: 'bold' },
        victoire: { position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)', background: 'white', padding: '25px 40px', borderRadius: '20px', boxShadow: '0 10px 40px rgba(0,0,0,0.3)', textAlign: 'center', animation: 'slideUp 0.5s ease' },
        detailEtoiles: { fontSize: '0.9rem', color: '#666', marginTop: '5px' },
        victoireBoutons: { display: 'flex', gap: '15px', marginTop: '15px', justifyContent: 'center' },
        boutonNouveau: { background: '#4CAF50', color: 'white', border: 'none', padding: '12px 25px', borderRadius: '10px', cursor: 'pointer', fontSize: '1rem' },
        boutonNiveauSup: { background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', color: 'white', border: 'none', padding: '12px 25px', borderRadius: '10px', cursor: 'pointer', fontSize: '1rem' },
        calcBtn: { position: 'fixed', bottom: '20px', right: '20px', width: '56px', height: '56px', borderRadius: '50%', background: '#1c1c1e', border: 'none', fontSize: '1.6rem', cursor: 'pointer', boxShadow: '0 4px 15px rgba(0,0,0,0.3)', zIndex: 999, display: 'flex', alignItems: 'center', justifyContent: 'center' },
        connexionBox: { background: 'white', borderRadius: '25px', padding: '40px', maxWidth: '450px', margin: '0 auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', textAlign: 'center' },
        inputPrenom: { width: '100%', padding: '15px 20px', fontSize: '1.2rem', border: '3px solid #e0e0e0', borderRadius: '15px', marginBottom: '20px', textAlign: 'center', fontFamily: 'inherit' },
        btnConnexion: { background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: 'white', border: 'none', padding: '15px 40px', fontSize: '1.2rem', borderRadius: '50px', cursor: 'pointer', width: '100%' },
        userBadge: { position: 'absolute', top: '20px', right: '20px', background: 'rgba(255,255,255,0.2)', padding: '8px 15px', borderRadius: '20px', color: 'white', fontSize: '0.9rem', display: 'flex', alignItems: 'center', gap: '8px' },
        decoBtn: { background: 'transparent', border: 'none', color: 'rgba(255,255,255,0.7)', cursor: 'pointer', fontSize: '0.8rem', marginLeft: '10px' },
      };

      // √âcran de connexion
      if (etape === 'connexion') {
        return (
          <div style={styles.container}>
            <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', padding: '20px' }}>
              <div style={styles.connexionBox}>
                <span style={{ fontSize: '60px', display: 'block', marginBottom: '20px' }}>üëã</span>
                <h1 style={{ color: '#667eea', marginBottom: '10px' }}>Bienvenue !</h1>
                <p style={{ color: '#666', marginBottom: '30px' }}>Comment t'appelles-tu ?</p>
                
                <input
                  type="text"
                  style={styles.inputPrenom}
                  placeholder="Ton pr√©nom..."
                  value={inputPrenom}
                  onChange={(e) => setInputPrenom(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && connexion()}
                  autoFocus
                />
                
                <button 
                  style={{...styles.btnConnexion, opacity: inputPrenom.trim().length < 2 ? 0.5 : 1}}
                  onClick={connexion}
                  disabled={inputPrenom.trim().length < 2}
                >
                  C'est parti ! üöÄ
                </button>
                
                <p style={{ color: '#999', fontSize: '0.85rem', marginTop: '20px' }}>
                  Ton pr√©nom sera utilis√© pour te saluer et sauvegarder tes progr√®s.
                </p>
              </div>
            </div>
          </div>
        );
      }

      // √âcran d'accueil
      if (etape === 'accueil') {
        return (
          <React.Fragment>
          <div style={styles.container}>
            <div style={styles.userBadge}>
              üë§ {prenomEleve}
              <button style={styles.decoBtn} onClick={deconnexion} title="Changer d'utilisateur">‚úï</button>
            </div>
            <div style={styles.accueil}>
              <div style={styles.logoContainer}>
                <span style={styles.logo}>üöÄ</span>
                <h1 style={styles.titre}>Vitesse, Distance & Dur√©e</h1>
                <p style={styles.sousTitre}>Deviens un as des calculs de mouvement !</p>
              </div>
              
              <div style={{ marginBottom: '30px' }}>
                <div style={styles.bulle}>
                  <p>Salut <strong>{prenomEleve}</strong> ! üëã Je suis l√† pour t'aider √† r√©soudre des probl√®mes de vitesse, distance et dur√©e. On va apprendre ensemble la m√©thode magique :</p>
                  <p style={styles.methode}><strong>Si... Alors... Donc...</strong></p>
                  <p>Pr√™t(e) √† devenir un(e) champion(ne) ? üèÜ</p>
                </div>
              </div>

              <button style={styles.boutonCommencer} onClick={() => setEtape('choix_niveau')}>
                Commencer l'aventure ! ‚ú®
              </button>

              <div style={styles.formules}>
                <h3 style={{color: 'white'}}>üìê Les formules √† conna√Ætre :</h3>
                <div style={styles.formulesGrid}>
                  <div style={styles.formuleCard}>
                    <span style={styles.formuleIcone}>‚ö°</span>
                    <p><strong>Vitesse</strong></p>
                    <p style={styles.formuleTexte}>v = D √∑ t</p>
                  </div>
                  <div style={styles.formuleCard}>
                    <span style={styles.formuleIcone}>üìè</span>
                    <p><strong>Distance</strong></p>
                    <p style={styles.formuleTexte}>D = v √ó t</p>
                  </div>
                  <div style={styles.formuleCard}>
                    <span style={styles.formuleIcone}>‚è±Ô∏è</span>
                    <p><strong>Temps</strong></p>
                    <p style={styles.formuleTexte}>t = D √∑ v</p>
                  </div>
                </div>
              </div>

              <div style={styles.methodeSection}>
                <h3>üìù La m√©thode magique : Si... Alors... Donc...</h3>
                <div style={styles.methodeExplication}>
                  <div style={styles.methodeEtape}>
                    <span style={styles.etapeNumero}>1</span>
                    <div style={styles.etapeContenu}>
                      <strong style={styles.etapeTitre}>Si...</strong>
                      <p style={styles.etapeDesc}>Je rappelle les donn√©es utiles de l'√©nonc√©</p>
                    </div>
                  </div>
                  <div style={styles.methodeEtape}>
                    <span style={styles.etapeNumero}>2</span>
                    <div style={styles.etapeContenu}>
                      <strong style={styles.etapeTitre}>Alors comme...</strong>
                      <p style={styles.etapeDesc}>Je choisis la bonne formule et je fais le calcul</p>
                    </div>
                  </div>
                  <div style={styles.methodeEtape}>
                    <span style={styles.etapeNumero}>3</span>
                    <div style={styles.etapeContenu}>
                      <strong style={styles.etapeTitre}>Donc...</strong>
                      <p style={styles.etapeDesc}>Je donne la r√©ponse avec une phrase compl√®te et l'unit√© !</p>
                    </div>
                  </div>
                </div>
              </div>

              <div style={styles.exempleSection}>
                <h3>‚úèÔ∏è Exemple corrig√©</h3>
                <div style={{ marginTop: '15px' }}>
                  <div style={styles.exempleEnonce}>
                    <span style={styles.exempleIcon}>‚ùì</span>
                    <p><strong>Probl√®me :</strong> Gaspard a march√© pendant 2h et a parcouru 16 km. √Ä quelle vitesse est-il all√© ?</p>
                  </div>
                  
                  <div style={styles.exempleSolution}>
                    <div style={styles.solutionLigne}>
                      <span style={styles.solutionLabel}>Si</span>
                      <p>Gaspard a parcouru <span style={styles.donnee}>16 km</span> en <span style={styles.donnee}>2 heures</span>.</p>
                    </div>
                    
                    <div style={styles.solutionLigne}>
                      <span style={styles.solutionLabel}>Alors</span>
                      <p>comme <span style={styles.formuleHighlight}>v = D √∑ t</span> = 16 √∑ 2 = <strong>8 km/h</strong></p>
                    </div>
                    
                    <div style={styles.solutionLigne}>
                      <span style={styles.solutionLabel}>Donc</span>
                      <p><span style={styles.reponseFinale}>Gaspard s'est d√©plac√© √† 8 km/h.</span></p>
                    </div>
                  </div>

                  <div style={styles.astuces}>
                    <p>üí° <strong>N'oublie pas :</strong></p>
                    <p>‚Ä¢ Souligne les donn√©es importantes dans l'√©nonc√©</p>
                    <p>‚Ä¢ Unit√©s de vitesse : <strong>km/h</strong> ou <strong>m/s</strong> uniquement</p>
                    <p>‚Ä¢ Conversion : 1 m/s = 3.6 km/h</p>
                    <p>‚Ä¢ Fais une phrase compl√®te pour la conclusion</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <button style={styles.calcBtn} onClick={() => setShowCalc(!showCalc)}>üßÆ</button>
          {showCalc && <Calculatrice onClose={() => setShowCalc(false)} />}
        </React.Fragment>
        );
      }

      // √âcran de choix du niveau
      if (etape === 'choix_niveau') {
        return (
          <React.Fragment>
          <div style={styles.container}>
            <div style={styles.userBadge}>
              üë§ {prenomEleve}
              <button style={styles.decoBtn} onClick={deconnexion} title="Changer d'utilisateur">‚úï</button>
            </div>
            <div style={styles.choixNiveau}>
              <h2 style={styles.titreNiveau}>{prenomEleve}, choisis ton niveau ! üéØ</h2>
              
              <div style={styles.scoreDisplay}>
                <span>‚≠ê {score.etoiles} √©toiles</span>
                <span>üìù {score.problemesResolus} probl√®mes r√©solus</span>
              </div>

              <div style={styles.niveauxGrid}>
                {niveaux.map((n) => (
                  <button
                    key={n.id}
                    style={{...styles.niveauCard, borderColor: n.couleur}}
                    onClick={() => choisirProbleme(n.id)}
                  >
                    <span style={styles.niveauNom}>{n.nom}</span>
                    <span style={styles.niveauDesc}>{n.description}</span>
                  </button>
                ))}
              </div>

              <button style={styles.boutonRetour} onClick={() => setEtape('accueil')}>
                ‚Üê Retour √† l'accueil
              </button>
            </div>
          </div>
          <button style={styles.calcBtn} onClick={() => setShowCalc(!showCalc)}>üßÆ</button>
          {showCalc && <Calculatrice onClose={() => setShowCalc(false)} />}
        </React.Fragment>
        );
      }

      // √âcran de r√©solution
      return (
        <React.Fragment>
        <div style={styles.container}>
          <div style={styles.header}>
            <button style={styles.boutonRetourPetit} onClick={() => setEtape('choix_niveau')}>
              ‚Üê Changer de niveau
            </button>
            <div style={styles.scoreHeader}>
              <span style={styles.etoiles}>‚≠ê {score.etoiles}</span>
              <span style={styles.badge}>
                {niveaux.find(n => n.id === niveau)?.nom}
              </span>
            </div>
          </div>

          <div style={styles.chatWrapper}>
            <div style={styles.stickyHeader}>
              <div style={styles.enonceFixe}>
                <span style={styles.enonceLabel}>üìù Probl√®me √† r√©soudre :</span>
                <p style={styles.enonceTexte}>{probleme.enonce}</p>
              </div>
              
              <div style={styles.progressionEtapes}>
                <span style={styles.progressionLabel}>Ta progression :</span>
                <div style={{...styles.etapeProgress, ...(etapesValidees.si ? styles.etapeValidee : {})}}>
                  {etapesValidees.si ? '‚úÖ' : '‚¨ú'} Si...
                </div>
                <div style={{...styles.etapeProgress, ...(etapesValidees.alors ? styles.etapeValidee : {})}}>
                  {etapesValidees.alors ? '‚úÖ' : '‚¨ú'} Alors...
                </div>
                <div style={{...styles.etapeProgress, ...(etapesValidees.donc ? styles.etapeValidee : {})}}>
                  {etapesValidees.donc ? '‚úÖ' : '‚¨ú'} Donc...
                </div>
              </div>
            </div>

            <div style={styles.chatContainer}>
              <div style={styles.messagesContainer}>
                {messages.map((msg, index) => (
                  <div
                    key={index}
                    style={{
                      ...styles.message,
                      ...(msg.role === 'user' ? styles.messageUser : styles.messageAssistant)
                    }}
                  >
                    {msg.role === 'assistant' && <span style={styles.avatar}>üßë‚Äçüè´</span>}
                    <div style={{
                      ...styles.messageBulle,
                      ...(msg.role === 'user' ? styles.bulleUser : styles.bulleAssistant)
                    }}>
                      {msg.content.split('\n').map((line, i) => (
                        <p key={i} style={styles.messageLine}>{line}</p>
                      ))}
                    </div>
                    {msg.role === 'user' && <span style={styles.avatar}>üë§</span>}
                  </div>
                ))}
                {isLoading && (
                  <div style={styles.loading}>
                    <span style={styles.loadingDot}>‚óè</span>
                    <span style={styles.loadingDot}>‚óè</span>
                    <span style={styles.loadingDot}>‚óè</span>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              <div style={styles.boutonsCopie}>
                <span style={styles.copieLabel}>üìã Reprendre :</span>
                <button 
                  style={styles.boutonCopie}
                  onClick={() => {
                    const dernierMessageUser = [...messages].reverse().find(m => m.role === 'user');
                    if (dernierMessageUser) {
                      setInputValue(dernierMessageUser.content);
                    }
                  }}
                  disabled={!messages.some(m => m.role === 'user')}
                >
                  Ma derni√®re r√©ponse
                </button>
                <button 
                  style={styles.boutonCopie}
                  onClick={() => {
                    const dernierMessageAssistant = [...messages].reverse().find(m => m.role === 'assistant');
                    if (dernierMessageAssistant) {
                      const lignes = dernierMessageAssistant.content.split('\n');
                      const suggestions = lignes.filter(l => 
                        l.match(/^(Si |Alors |Donc )/i) || 
                        l.includes('v =') || l.includes('D =') || l.includes('t =') ||
                        l.includes('v=') || l.includes('D=') || l.includes('t=')
                      ).join('\n');
                      if (suggestions) {
                        setInputValue(suggestions);
                      } else {
                        const guillemets = dernierMessageAssistant.content.match(/"([^"]+)"/g);
                        if (guillemets) {
                          setInputValue(guillemets.map(g => g.replace(/"/g, '')).join('\n'));
                        }
                      }
                    }
                  }}
                  disabled={messages.length < 2}
                >
                  Suggestion de l'assistant
                </button>
              </div>

              <div style={styles.inputContainer}>
                <textarea
                  style={styles.input}
                  value={inputValue}
                  onChange={(e) => setInputValue(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      envoyerMessage();
                    }
                  }}
                  placeholder="√âcris ta r√©ponse ici... (Entr√©e pour envoyer)"
                  rows={3}
                />
                <button 
                  style={{...styles.boutonEnvoyer, opacity: isLoading ? 0.5 : 1}}
                  onClick={envoyerMessage}
                  disabled={isLoading}
                >
                  Envoyer üì§
                </button>
              </div>

              <div style={styles.aideRapide}>
                <span style={styles.aideLabel}>üí° Rappels :</span>
                <button style={styles.aideBtn} onClick={() => setInputValue(prev => prev + 'Si ')}>Si...</button>
                <button style={styles.aideBtn} onClick={() => setInputValue(prev => prev + 'Alors comme ')}>Alors comme...</button>
                <button style={styles.aideBtn} onClick={() => setInputValue(prev => prev + 'Donc ')}>Donc...</button>
                <span style={styles.formuleRappel}>v=D/t ‚Ä¢ D=v√ót ‚Ä¢ t=D/v ‚Ä¢ 1m/s=3.6km/h</span>
              </div>
            </div>
          </div>

          {problemeResolu && (
            <div style={styles.victoire}>
              <h3>üéâ Exercice termin√© !</h3>
              <p>Tu as gagn√© <strong>{aideUtilisee ? '4' : '5'} √©toiles</strong> sur cet exercice !</p>
              <p style={styles.detailEtoiles}>
                ‚≠ê Si... + ‚≠ê Alors... + {aideUtilisee ? '‚≠ê Donc... + bonus' : '‚≠ê‚≠ê Donc... + bonus'}
              </p>
              <div style={styles.victoireBoutons}>
                <button style={styles.boutonNouveau} onClick={() => nouveauProbleme()}>
                  M√™me niveau üîÑ
                </button>
                {niveau !== 'expert' && (
                  <button style={styles.boutonNiveauSup} onClick={niveauSuivant}>
                    Niveau sup√©rieur üöÄ
                  </button>
                )}
              </div>
            </div>
          )}
        </div>
        <button style={styles.calcBtn} onClick={() => setShowCalc(!showCalc)}>üßÆ</button>
        {showCalc && <Calculatrice onClose={() => setShowCalc(false)} />}
        </React.Fragment>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VitesseApp />);
  </script>
</body>
</html>
